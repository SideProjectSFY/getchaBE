<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.backend.goods.model.GoodsMapper">

    <!-- 굿즈 등록 -->
    <insert id="insertGoods" parameterType="Goods" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO goods(
            seller_id,
            anime_id,
            category,
            title,
            description,
            start_price,
            instant_buy_price,
            auction_status,
            duration,
            auction_end_at,
            created_at
        )
        VALUES (
            #{sellerId},
            #{animeId},
            #{category},
            #{title},
            #{description},
            #{startPrice},
            #{instantBuyPrice},
            'WAIT',
            #{duration},
            #{auctionEndAt},
            #{createdAt}
        );
    </insert>

    <!-- 사용자가 등록한 굿즈 목록 조회 -->
    <select id="selectAllRegisteredGoods" resultType="com.ssafy.backend.goods.model.GoodsResponseDto$MyPageInRegisteredGoodsCard">
        SELECT
            g.id as goodsId,
            g.title as title,
            g.category as category,
            g.auction_status as auctionStatus,
            g.start_price as startPrice,
            MAX(ta.title) AS animeTitle,
            MAX(b.bid_amount) AS currentBidAmount,
            MAX(gi.file_path) AS mainFilePath
        FROM goods g
            LEFT JOIN bid b ON b.goods_id = g.id AND b.is_highest = TRUE
            LEFT JOIN goods_image gi ON gi.goods_id = g.id AND gi.sort_order = 1
            LEFT JOIN tmdb_anime ta ON ta.id = g.anime_id
        WHERE
            g.deleted_at IS NULL
            AND g.seller_id = #{loginUserId}
        GROUP BY g.id
        ORDER BY g.created_at DESC
    </select>

    <!-- 사용자가 참여한 굿즈 목록 조회 -->
    <select id="selectAllParticipatedGoods" resultType="com.ssafy.backend.goods.model.GoodsResponseDto$MyPageInParticipatedGoodsCard">
        SELECT
            g.id AS goodsId,
            g.title AS title,
            ta.title AS animeTitle,
            g.category AS category,
            g.auction_status AS auctionStatus,
            MAX(gi.file_path) AS mainFilePath,
            (
                SELECT MAX(b2.bid_amount)
                FROM bid b2
                WHERE b2.goods_id = g.id
            ) AS currentBidAmount,
            (
                SELECT MAX(b3.bid_amount)
                FROM bid b3
                WHERE b3.goods_id = g.id
                AND b3.bidder_id = #{loginUserId}
            ) AS myBidAmount
        FROM goods g
            INNER JOIN bid b
                ON b.goods_id = g.id
                AND b.bidder_id = #{loginUserId}
            LEFT JOIN tmdb_anime ta
                ON ta.id = g.anime_id
            LEFT JOIN goods_image gi
                ON gi.goods_id = g.id
                AND gi.sort_order = 1
        WHERE g.deleted_at IS NULL
        GROUP BY g.id
        ORDER BY g.created_at DESC
    </select>

    <!-- 굿즈 목록 조회 (검색/필터) -->
    <select id="selectAllGoodsBySearch" resultType="com.ssafy.backend.goods.model.GoodsResponseDto$GoodsCard">
        SELECT
            g.id AS goodsId,
            g.title AS title,
            g.seller_id AS sellerId,
            g.category AS category,
            g.auction_status AS auctionStatus,
            g.auction_end_at AS auctionEndAt,
            g.start_price AS startPrice,
            g.created_at AS createdAt,
            MAX(u.nickname) AS sellerNickname,
            MAX(ta.title) AS animeTitle,
            MAX(b.bid_amount) AS currentBidAmount,
            MAX(gi.file_path) AS mainFilePath,
            COUNT(w.id) AS wishCount,
            CASE
                WHEN #{loginUserId} IS NULL THEN 0
                ELSE MAX(CASE WHEN w.user_id = #{loginUserId} THEN 1 ELSE 0 END)
            END AS checkWish
        FROM goods g
            LEFT JOIN user u ON g.seller_id = u.id
            LEFT JOIN bid b ON b.goods_id = g.id AND b.is_highest = TRUE
            LEFT JOIN goods_image gi ON gi.goods_id = g.id AND gi.sort_order = 1
            LEFT JOIN wishlist w ON w.goods_id = g.id
            LEFT JOIN tmdb_anime ta ON ta.id = g.anime_id
        <where>
            g.deleted_at IS NULL
            <if test="goodsLookUp.auctionStatus != null">
                and auction_status = #{goodsLookUp.auctionStatus}
            </if>
            <if test="goodsLookUp.category != null">
                and category = #{goodsLookUp.category}
            </if>
            <if test="goodsLookUp.searchName != null and goodsLookUp.searchName != ''">
                and (
                    g.title LIKE CONCAT('%', #{goodsLookUp.searchName}, '%')
                    OR ta.title LIKE CONCAT('%', #{goodsLookUp.searchName}, '%')
                )
            </if>
        </where>
        GROUP BY g.id
        ORDER BY
            <choose>
                <when test="goodsLookUp.sort.equals('price')">
                    COALESCE(MAX(b.bid_amount), g.start_price) DESC
                </when>
                <when test="goodsLookUp.sort.equals('wish')">
                    wishCount DESC
                </when>
                <when test="goodsLookUp.sort.equals('auctionEndAt')">
                    g.auction_end_at ASC
                </when>
                <otherwise>
                    createdAt DESC
                </otherwise>
            </choose>
        LIMIT #{goodsLookUp.size} OFFSET #{goodsLookUp.offset}
    </select>

    <!-- 총 굿즈 글 갯수 -->
    <select id="countGoods" parameterType="com.ssafy.backend.goods.model.GoodsRequestDto$GoodsLookUp">
        SELECT
        count(*)
        FROM goods g
            LEFT JOIN tmdb_anime ta ON ta.id = g.anime_id
        <where>
            g.deleted_at IS NULL
            <if test="auctionStatus != null">
                and auction_status = #{auctionStatus}
            </if>
            <if test="category != null">
                and category = #{category}
            </if>
            <if test="searchName != null and searchName != ''">
                and (
                    g.title LIKE CONCAT('%', #{searchName}, '%')
                    OR ta.title LIKE CONCAT('%', #{searchName}, '%')
                )
            </if>
        </where>
    </select>

    <!-- 굿즈 상세 조회 -->
    <select id="selectGoodsById" parameterType="Long" resultType="com.ssafy.backend.goods.model.GoodsResponseDto$GoodsDetail">
        SELECT
            g.id AS goodsId,
            anime_id,
            seller_id,
            u.nickname AS sellerNickName,
            (select userTa.poster_url from tmdb_anime userTa where u.liked_anime_id1 = userTa.id) AS sellerProfileFilePath,
            category,
            ta.title AS animeTitle,
            ta.poster_url AS animePosterUrl,
            g.title,
            description,
            start_price,
            b.bid_amount AS currentBidAmount,
            instant_buy_price,
            auction_status,
            g.duration,
            g.created_at,
            auction_end_at,
            (
                SELECT count(*)
                FROM wishlist
                WHERE goods_id = g.id
            ) AS wishCount,
            (
                SELECT EXISTS(
                    SELECT 1 FROM wishlist
                    WHERE goods_id = g.id
                    AND user_id = #{loginUserId})
            ) AS checkWish,
            (g.seller_id = #{loginUserId}) AS checkSeller
        FROM goods g
            INNER JOIN user u
                ON u.id = g.seller_id
            LEFT JOIN tmdb_anime ta
                ON ta.id = g.anime_id
            LEFT JOIN bid b
            ON b.goods_id = g.id AND b.is_highest IS TRUE
        WHERE g.id = #{goodsId}
          AND g.deleted_at IS NULL
    </select>

    <!-- 경매에 입찰한 참여자 리스트 조회 -->
    <select id="selectBidParticipantByGoodsId" parameterType="Long" resultType="com.ssafy.backend.goods.model.GoodsResponseDto$BidParticipant">
        SELECT
            DENSE_RANK() OVER (ORDER BY max_bid_amount DESC) AS bidRank,
            bidder_id,
            u.nickname AS bidderNickName,
            ta.poster_url AS bidderProfileFilePath,
            max_bid_amount AS bidAmount,
            is_highest
        FROM (
            SELECT
                bidder_id,
                MAX(bid_amount) AS max_bid_amount,
                MAX(is_highest) AS is_highest
            FROM bid
            WHERE goods_id = #{goodsId}
            GROUP BY bidder_id
        ) b
            LEFT JOIN user u
                ON b.bidder_id = u.id
                AND u.deleted_at IS NULL
            LEFT JOIN tmdb_anime ta
                ON ta.id = u.liked_anime_id1
        ORDER BY bidRank
    </select>

    <!-- 특정 굿즈 글의 다중 이미지 리스트 조회 -->
    <select id="selectImagesByGoodsId" parameterType="Long" resultType="com.ssafy.backend.goods.model.GoodsResponseDto$GoodsDetailImage">
        SELECT
            gi.id AS imageId,
            goods_id,
            file_path,
            sort_order
        FROM goods_image gi
            JOIN goods g
                ON g.id = gi.goods_id
                AND g.deleted_at IS NULL
        WHERE goods_id = #{goodsId}
        ORDER BY sort_order;
    </select>

    <!-- 굿즈 글 수정 (*경매 대기 일 경우에만 가능)-->
    <update id="updateGoods" parameterType="com.ssafy.backend.goods.model.GoodsRequestDto$GoodsModify">
        UPDATE goods
        SET
            title = #{goodsModify.title},
            anime_id = #{goodsModify.animeId},
            category = #{goodsModify.category},
            description = #{goodsModify.description},
            start_price = #{goodsModify.startPrice},
            instant_buy_price = #{goodsModify.instantBuyPrice},
            duration = #{goodsModify.duration},
            auction_end_at = #{auctionEndAt},
            updated_at = NOW()
        WHERE auction_status = 'WAIT'
            AND id = #{goodsModify.goodsId}
            AND seller_id = #{loginUserId}
            AND deleted_at IS NULL;
    </update>

    <!-- 굿즈 글 SOFT 삭제 (*진행중이 아닐 경우에만 삭제) -->
    <update id="deleteGoods" parameterType="Long">
        UPDATE goods
            SET deleted_at = NOW()
        <where>
            seller_id = #{loginUserId}
            <if test="goodsId != null">
                AND id = #{goodsId}
            </if>
            AND auction_status != 'PROCEEDING'
            AND deleted_at IS NULL
        </where>
    </update>

    <!--  본인 글인지 체크 -->
    <select id="selectSellerIdByGoodsId" resultType="long">
        SELECT seller_id
        FROM goods
        WHERE id = #{goodsId}
    </select>


    <!-- 굿즈 존재 여부 (파라미터에 따라 다르게 조회) -->
    <select id="existsActiveGoodsByUserId">
        SELECT EXISTS(
            SELECT 1
            FROM goods
            <where>
                <if test="goodsId == null">
                    seller_id = #{loginUserId}
                    AND auction_status = 'PROCEEDING'
                </if>
                <if test="goodsId != null">
                    id = #{goodsId}
                </if>
                AND deleted_at IS NULL
            </where>
        );
    </select>

    <!-- PROCEEDING 제외 ! 등록한 굿즈 글 개수 확인-->
    <select id="existsGoodsByUserId" resultType="int">
        SELECT count(*)
        FROM goods
        WHERE seller_id = #{loginUserId}
        AND auction_status != 'PROCEEDING'
        AND deleted_at IS NULL
    </select>


    <!-- 굿즈 다중 이미지(=파일) 업로드 -->
    <insert id="insertFiles" parameterType="GoodsImage" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO goods_image (
            goods_id,
            file_path,
            origin_filename,
            stored_filename,
            file_size,
            sort_order
        )
        VALUES (
            #{goodsId},
            #{filePath},
            #{originFilename},
            #{storedFilename},
            #{fileSize},
            #{sortOrder}
        )
    </insert>

    <!-- 삭제할 이미지파일ID의 정보 조회-->
    <select id="selectDeleteImageFileByFileId" resultType="GoodsImage" parameterType="java.util.List">
        SELECT id, stored_filename
        FROM goods_image
        WHERE id IN
        <foreach collection="deleteImageIds" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>;
    </select>

    <!-- 파일Id 리스트 삭제 -->
    <delete id="deleteGoodsImageByFileId" parameterType="java.util.List">
        DELETE FROM goods_image
        WHERE id IN
        <foreach collection="deleteImageIds" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>;
    </delete>

    <!--  기존 이미지 sort_order 업데이트 -->
    <update id="updateImageSortOrder">
        UPDATE goods_image
        SET sort_order = CASE id
        <foreach collection="images" item="img">
            WHEN #{img.imageId} THEN #{img.sortOrder}
        </foreach>
            ELSE sort_order
        END
        WHERE goods_id = #{goodsId}
    </update>

    <!-- 신규 이미지 next sort_order 조회 -->
    <select id="selectNextSortOrder">
        SELECT COALESCE(MAX(sort_order), 0) + 1
        FROM goods_image
        WHERE goods_id = #{goodsId}
    </select>


    <select id="selectPAWRecommendGoodsList"
            resultType="com.ssafy.backend.ai.model.RecommendedResponseDto$RecommendedGoods">
        SELECT
            g.id AS goodsId,
            g.title AS title,
            g.seller_id AS sellerId,
            g.category AS category,
            g.auction_status AS auctionStatus,
            g.auction_end_at AS auctionEndAt,
            g.start_price AS startPrice,
            g.created_at AS createdAt,
            g.anime_id AS animeId,
            MAX(u.nickname) AS sellerNickname,
            MAX(ta.title) AS animeTitle,
            MAX(b.bid_amount) AS currentBidAmount,
            MAX(gi.file_path) AS mainFilePath,
            COUNT(w.id) AS wishCount,
            CASE
                WHEN #{userId} IS NULL THEN 0
                ELSE MAX(CASE WHEN w.user_id = #{userId} THEN 1 ELSE 0 END)
            END AS checkWish
        FROM goods g
        LEFT JOIN user u ON g.seller_id = u.id
        LEFT JOIN bid b ON b.goods_id = g.id AND b.is_highest = TRUE
        LEFT JOIN goods_image gi ON gi.goods_id = g.id AND gi.sort_order = 1
        LEFT JOIN wishlist w ON w.goods_id = g.id
        LEFT JOIN tmdb_anime ta ON ta.id = g.anime_id
        where g.deleted_at IS NULL
        and g.auction_status IN('WAIT','PROCEEDING')
        AND g.seller_id != #{userId}
        AND g.anime_id IN
        <foreach collection="animeIds" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        AND NOT EXISTS (
            SELECT 1
            FROM wishlist w
            WHERE w.goods_id = g.id
            AND w.user_id = #{userId}
        )
        GROUP BY g.id
        ORDER BY
            createdAt DESC;
    </select>

    <!-- AI 추천 결과 : goodsId 목록으로 GoodsCard(이미지 포함) 조회 -->
    <select id="selectGoodsCardsByIds" parameterType="list" resultType="com.ssafy.backend.goods.model.GoodsResponseDto$GoodsCard">
        SELECT
            g.id AS goodsId,
            g.seller_id AS sellerId,
            g.category,
            g.title,
            g.start_price AS startPrice,
            g.auction_status AS auctionStatus,
            g.auction_end_at AS auctionEndAt,
            g.created_at AS createdAt,

            MAX(image.file_path) AS mainFilePath,
            MAX(tmdb.title) AS animeTitle,
            MAX(bid.bid_amount) AS currentBidAmount,

            COUNT(wish.id) AS wishCount,
            0 AS checkWish <!-- ai 추천 굿즈는 내가 좋아요 한 굿즈를 애초에 제외하기 때문에 걍 0 처리 -->

        FROM goods g
            LEFT JOIN goods_image image
                ON image.goods_id = g.id
                AND image.sort_order = 1

            LEFT JOIN tmdb_anime tmdb
                ON tmdb.id = g.anime_id

            LEFT JOIN bid
                ON bid.goods_id = g.id
                AND bid.is_highest = TRUE

            LEFT JOIN wishlist wish
                ON wish.goods_id = g.id

        WHERE g.id IN
            <foreach collection="goodsIds" item="id" open="(" close=")" separator=",">
                #{id}
            </foreach>
        GROUP BY g.id
    </select>

</mapper>