<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.backend.notification.model.NotificationMapper">
    <!-- 1. 읽지 않은 알림 목록 조회 -->
    <select id="findUnreadByUserId" parameterType="long" resultType="com.ssafy.backend.notification.model.Notification">
        SELECT *
        FROM notification
        WHERE user_id = #{userId}
            AND read_at IS NULL
        ORDER BY created_at DESC
    </select>

    <!-- 2. 알림 insert -->
    <insert id="insertNotification"
            parameterType="com.ssafy.backend.notification.model.Notification"
            useGeneratedKeys="true"
            keyProperty="id"
            keyColumn="id">
        INSERT INTO notification(user_id, type, message, created_at, read_at, link)
        VALUES (#{userId}, #{type}, #{message}, #{createdAt}, #{readAt}, #{link})
    </insert>
    
    <!-- 3. 알림 단 건 읽음 처리 -->
    <update id="markAsRead" parameterType="long">
        UPDATE notification
        SET read_at = NOW()
        WHERE id = #{notificationId}
    </update>
    
    <!-- 4. 알림 전체 읽음 처리 -->
    <update id="markAllAsRead" parameterType="long">
        UPDATE notification
        SET read_at = NOW()
        WHERE user_id = #{userId}
            AND read_at IS NULL
    </update>

</mapper>

